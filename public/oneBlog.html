<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blogs</title>
    <script src="https://kit.fontawesome.com/a05ef9628f.js" crossorigin="anonymous"></script> 
    <link
    rel="stylesheet"
    href="https://unicons.iconscout.com/release/v4.0.0/css/line.css"
  />
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/skills.css">
    <link rel="stylesheet" href="../css/blogs.css">
</head>
<body>
    <div class="navbar">
        <div class="links-cont">
            <a href="./index.html">Home</a>
            <a href="./index.html#aboutme">About me</a>
            <a href="./index.html#portfolio">Portfolio</a>
            <a href="./index.html#skills">Skills</a>
            <a href="./index.html#contactme">Contact me</a>
            <a href="./blogs.html" class="active-link">Blogs</a>
       
           <div>
            <a id="logSign" style="text-decoration: none;" href="./login.html"><button class="btn">Login/Signup</button></a>
            <div id="profileauth" class="loggedUser">
              <div class="dropdown  ">
              <div style="display: flex;">
                <div class="imggg">
                  <img src="../images/me.png" alt="">
                </div>
                &nbsp;<p style="font-weight: bold;font-style: italic;" id="username-display"></p>
              </div>
                
                <div class="dropdown-content">
                  <a href="./userProfile.html">Your Profile</a>
                  <a href="#">Settings</a>
                <a href="#" onclick="logout()">Logout</a>
                </div>
              </div>
            </div>
           </div>
        </div>
    </div>

  
    <div class="left-side-bar">

        <div class="logo-cont">
            
        </div>

     

        <div class="bottom-line">
        </div>

    </div>

    <div class="right-cont">
        
        <!-- <div class="container" id="containerBlogs"> -->

          <div id="blogsCntainer" class="singleBlog">
          
          </div>

          <br/><div class="post-meta"><span class="timestamp"><i class="fa fa-clock-"></i> <span id="time-posted"></span></span>
            <!-- &nbsp;    &nbsp;    &nbsp;<span class="comments"><i class="fa-solid fa-comment"></i> 34</span> -->
            &nbsp;    &nbsp;
            <span onclick="addLike()" class="comments likesss"><i class="fa fa-thumbs-up"></i> <span id="totalLikes"></span> </span>
        </div>

        <div class="comment-area">
            <div class="form__div textarea-cont form__div2">
              <textarea id="text" onkeyup="validateMessage()" onblur="validateMessage()" class="form__input commentinput" placeholder=" "></textarea>
              <label for="" id="messagelabel" class="form__label">Write your comment</label>
              <p id="messageError2"></p>
            </div>

            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <div class="commentBtn">
                <button onclick="login()" class="addcommentbtn"><i class="fa-solid fa-comment"></i> Add Comment</button>
            </div>
        </div>

        <div class="comments-section">
          <div class="header-title">
            <h4>All Comments (<span id="allC"></span>) <button id="showIc" onclick="toggleComments()"><i class="fa fa-angle-right"></i></button> <button id="hideIc" onclick="hideComments()"><i class="fa fa-angle-right"></i></button> </h4>
          </div>

          <div id="allComments">

      </div>
        </div>

    </div>

    </div>

    <div class="navbars-cont" id="menuBottom">

      <div class="top-one-social">
           <a href="./index.html#" onclick="hideMenu()">
            <div>
              <i class="fa fa-home change-theme"></i>
              <p>Home</p>
             </div>
           </a>
         <a href="./index.html#aboutme" onclick="hideMenu()">
          <div>
            <i class="fa fa-user change-theme"></i>
            <p>About me</p>
           </div>
         </a>
         <a href="./index.html#portfolio" onclick="hideMenu()">
          <div>
            <i class="change-theme fa-solid fa-diagram-project"></i>
            <p>Portfolio</p>
           </div>
         </a>
      </div>

      <div class="top-one-social">
        <a href="./blogs.html">
          <div>
            <i class="change-theme fa-solid fa-blog"></i>
            <p>Blogs</p>
           </div>
        </a>
      <a href="./index.html#skills" onclick="hideMenu()">
        <div>
          <i class="change-theme fa-solid fa-graduation-cap"></i>
          <p>Skills</p>
         </div>
      </a>
       <a href="./index.html#contactme" onclick="hideMenu()">
        <div>
          <i class="uil uil-message change-theme"></i>
          <p>Contact me</p>
         </div>
       </a>
   </div>
   <a href="./login.html" class="closeBtn" style="float: left;margin-left: 37px;margin-top: 3px;">
    <i class="fa fa-sign-in"></i> Login
    </a>
    <div class="closeBtn">
      <!-- <a href="#news"><i class="fa-moon uil uil-moon change-theme"></i></a> -->
      <a onclick="hideMenu()"><i class="fa fa-close change-theme"></i></a>
    </div>
    </div>
    <div class="navbars">
      <a href="#home">
        <div class="logo-cont2">
            
        </div>
      </a>
    <div>
      <form action="">
        <a href="#news"><i class="fa-moon uil uil-moon change-theme"></i></a>
        <!-- <input type="checkbox" id="menus">
      <label for="menus">toggle</label> -->
      <a onclick="menuBottom()"><i class="fa fa-bars change-theme"></i></a>
      </form>
    </div>
    </div>
  
    </div>

    <script>
     let blogs = document.getElementsByClassName("column");

     for(let i=0; i<blogs.length; i++){
       blogs[i].addEventListener("click", (e)=>{
         window.location = "./blog-view.html"
       })
     }

     function menuBottom(){
    document.getElementById("menuBottom").style.display = "block"
  }

  
  function hideMenu(){
    document.getElementById("menuBottom").style.display = "none"
  }

  function logout(){
  localStorage.removeItem("token");
 return isLogged();
}

function isLogged(username){

 let token = localStorage.getItem("token")

 if(token){

  fetch("/users/loggedinuser", {
    method: 'GET',
    headers: {
        'Authorization': token
    }
  })
  .then((res) => res.json())
    .then((res) =>{
      if(res.username){
        document.getElementById("logSign").style.display = "none"
   document.getElementById("profileauth").style.display = "flex"
   document.getElementById("username-display").innerHTML  = res.username;
   localStorage.setItem("userId", res._id)
   return ;
      }else{
        document.getElementById("logSign").style.display = "block"
   document.getElementById("profileauth").style.display = "none"
      }
    });
 }if(!token){
  document.getElementById("logSign").style.display = "block"
   document.getElementById("profileauth").style.display = "none"
 }
}

window.onload = function(){
  isLogged('')
  getSingleBlog()
}

function getAllUsers(id,ids){
  // let token = localStorage.getItem("token");

  fetch("users/"+id, {
    method: 'GET',
    headers: {
      'Authorization': token
    }
  })
  .then((res) => res.json())  
    .then((user) =>{
     let all = document.getElementsByClassName(ids);
     for(let a=0; a<all.length; a++){
      document.getElementsByClassName(ids)[a].innerHTML = user?.username;
     }
    });
}
function getSingleBlog(){
  let url = window.location.href;
  let arrs = url.split("=");
  let id = arrs[1];

  let token = localStorage.getItem("token");
  
if(token){
  fetch("/users/loggedinuser", {
    method: 'GET',
    headers: {
      'Authorization': token
    }
  })
  .then((res) => res.json())  
    .then((user) =>{
    localStorage.setItem("id", user._id)
    });
}

  fetch("/blogs/"+id, {
    method: 'GET',
    headers: {
      'Authorization': token
    }
  })
  .then((res) => res.json())  
    .then((blogs) =>{
        //   for(let i=0; i<1; i++){
document.getElementById("allC").innerHTML = blogs?.comments?.length;
document.getElementById("time-posted").innerHTML = new Date(blogs?.createdAt).toLocaleDateString();
document.getElementById("allComments").innerHTML = "";


// blogs.comments = blogs?.comments?.sort((a, b) => {
//     return a.date - b.date;
// });
document.getElementById("totalLikes").innerHTML = blogs?.likes.length;
if(blogs?.likes.includes(localStorage.getItem("id"))){
  document.getElementsByClassName("likesss")[0].style.color = "blue"
}
if(!blogs?.likes.includes(localStorage.getItem("id"))){
  document.getElementsByClassName("likesss")[0].style.color = "black"
}
          for(let j=blogs?.comments?.length-1; j>=0; j--){
            let ex=`
   <p class="dots" onclick="toggleM('${blogs?.comments[j]?._id}')"><i class="fa-solid fa-ellipsis"></i></p>
   
`
            getAllUsers(blogs?.comments[j]?.userId,blogs?.comments[j]?.userId)
            document.getElementById("allComments").innerHTML += `
            <div class="comment-one">
           <div class="profile-commenter">
             <img src="./images/me.jpg" alt="">
           </div>

           <div class="user-info">
            <div style="position: relative;width: 100%;">
             <div style="display: flex;"">
              <p style="font-weight: bold;" class="${blogs?.comments[j]?.userId}"></p>
              <p style="margin-left: 50px;font-size: 14px; color: darkslategray;top: 7px;position: relative;"> ${new Date(blogs?.comments[j]?.date)?.toLocaleDateString()}</p>
              </div>

${
  localStorage.getItem("id") == blogs?.comments[j]?.userId && localStorage.getItem("token") ?
 ex
  :
  `<p></p>`
}
                         
              </div>
              <div class="menusss" id="${blogs?.comments[j]?._id}">
                <p class="delB" onclick="deleteComment('${blogs?.comments[j]?._id}')">Delete Comment</p>
                </div>
             <p style="position: relative;top: -12px;">${blogs?.comments[j]?.postedBy}</p>
           </div>
         </div>
            `
          }

          let arr = blogs?.text?.split("```");

           document.getElementById("blogsCntainer").innerHTML = `
           <div>
            <img class='b-img-b' src="${blogs?.fileUrl}">
            </div>
            <div>
            <h2>${blogs?.title}</h1>
            </div>

            <div>
            ${
               elems(arr)
            }
            </div><br>
           `
        //   }
    })
}

function isOdd(index){
    if(index%2 != 0){
        return true;
    }

    return false;
}

function remove(){
    let a =  document.getElementById("blogsCntainer").innerHTML;

    alert(a)
}

function elems(x){

    let v = x.map((t,index)=>{
        return `
        ${
            isOdd(index) && t?.trim()?.length>0 ? 
                `
                <div class="codes">
                    ${t}
                    </div>
                    `
                :
                `
                <div>
                    ${t}
                    </div>
                    `
        }
        `
    })

   v = v.join("")

    return v;
} 


function toggleComments(){
  document.getElementById("allComments").style.display = "block"
  document.getElementById("showIc").style.display = "none"
  document.getElementById("hideIc").style.display = "inline"
}

function hideComments(){
  document.getElementById("allComments").style.display = "none"
  document.getElementById("showIc").style.display = "inline"
  document.getElementById("hideIc").style.display = "none"
}

function validateMessage(){
  let message = document.getElementById("text").value.trim();

  if(message.length == 0){
      document.getElementById("messageError2").style.display = "block"
      document.getElementById("text").style.borderColor="orangered"
      document.getElementById("messagelabel").style.color="orangered"
      document.getElementById("messageError2").innerHTML = "Message is required*"
      return false;
    }
    if(message.length>0){
      document.getElementById("messageError2").style.display = "none"
      document.getElementById("text").style.borderColor="forestgreen"
      document.getElementById("messagelabel").style.color="forestgreen"
      document.getElementById("messageError2").innerHTML = ""
      return true;
    }
}

function login(){
  if(!localStorage.getItem("token")){
    let c = confirm("Login First to add comment")

    if(c){
     return window.location = "./login.html"
    }

    return ;
  }

  let isValid = validateMessage();
  let text = document.getElementById("text").value.trim();
  let token = localStorage.getItem("token");
  let userId = localStorage.getItem("userId");
  let url = window.location.href;
  let arrs = url.split("=");
  let id = arrs[1];
let comment={
  text: text,
}
  if(isValid == true){
    fetch("/blogs/"+id+"/comment", {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    userId: userId,
                    comments: comment
                })
            }).then((res) => res)
            .then((data) =>{
             console.log(data)
             document.getElementById("text").value = "";
             getSingleBlog();
             getAllUsers();

             document.body.scrollTop = 50000;
            })
            .catch((error)=>{
              console.log(error)
            })
  }

}

function toggleM(id){
  if(document.getElementById(id).style.display =="block"){
    return  document.getElementById(id).style.display = "none"
  }
  return document.getElementById(id).style.display = "block"
}

function addLike(){
  let url = window.location.href;
  let arrs = url.split("=");
  let id = arrs[1];
  let token = localStorage.getItem("token");

  if(!token){
    let c = confirm("Login First to like this blog")

if(c){
 return window.location = "./login.html"
}
  }

  fetch(`/blogs/${id}/like`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                }
            }).then((res) => res)
            .then((data) =>{
            console.log(data)
            getSingleBlog();
            getAllUsers();
            });
}

    </script>
</body>
</html>